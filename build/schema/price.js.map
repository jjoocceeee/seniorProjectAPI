{"version":3,"sources":["../../src/schema/price.js"],"names":["_","require","addDays","differenceInDays","subDays","format","priceSchema","mongoose","Schema","openPrice","type","Number","description","required","closePrice","volume","date","Date","index","ticker","String","Price","model","customizationOptions","PriceTC","addResolver","name","args","resolve","source","context","CheckTwentyDay","highCheck","indexDate","twentyDayHighDate","twenty","checkPullBack","highPrice","console","log","price_array","Promise","all","universe","map","stock","findOne","prices","push","prevhigh","number","amount","pullbackDate","find","$lte","$gt","high","check","forEach","price","twentyBefore","highPriceDate","highDate"],"mappings":"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","sourcesContent":["import { composeWithMongoose } from 'graphql-compose-mongoose/node8';\r\nimport mongoose, { mongo } from 'mongoose';\r\nimport universe from '../universe';\r\n// import { addHours } from 'date-fns/esm';\r\n\r\nvar _ = require('lodash');\r\nvar addDays = require('date-fns/addDays');\r\nvar differenceInDays = require('date-fns/differenceInDays')\r\nvar subDays = require('date-fns/subDays')\r\nvar format = require('date-fns/format')\r\nconst priceSchema = new mongoose.Schema({\r\n  openPrice: {\r\n    type: Number,\r\n    description: \"Opening Price of Stock.\",\r\n    required: true\r\n  }, \r\n  closePrice: {\r\n    type: Number,\r\n    description: \"Closing Price of Stock.\",\r\n    required: true\r\n  }, \r\n  volume: {\r\n    type: Number,\r\n    description: \"Volume of Stocks sold that day.\",\r\n    required: true\r\n  }, \r\n  date: {\r\n    type: Date,\r\n    description: \"Date-Time for this price.\",\r\n    required: true,\r\n    index: true\r\n  },\r\n  ticker: {\r\n    type: String,\r\n    description: \"Stock this price is associated with.\",\r\n    required: true,\r\n    index:true\r\n  }\r\n});\r\n\r\nconst Price = mongoose.model('Price', priceSchema);\r\nconst customizationOptions = {};\r\nconst PriceTC = composeWithMongoose(Price, customizationOptions);\r\n\r\nPriceTC.addResolver({\r\n  name: \"checkTwentyDayHigh\",\r\n  type: \"Boolean\",\r\n  args: {\r\n    date: \"Date!\",\r\n    ticker: \"String!\"\r\n  },\r\n  resolve: async ({args, source, context}) => {\r\n    return await CheckTwentyDay(args.date).highCheck\r\n  }\r\n})\r\n\r\nPriceTC.addResolver({\r\n  name: \"fourCandleHammer\",\r\n  type: \"Boolean\",\r\n  args: {\r\n    date: \"Date!\",\r\n    ticker: \"String!\",\r\n  },\r\n  resolve: async ({args, source, context}) => {\r\n      let indexDate = new Date(args.date);\r\n      let twentyDayHighDate = new Date(addDays(indexDate, -24));\r\n      let twenty = await CheckTwentyDay(twentyDayHighDate);\r\n      if(twenty.highCheck){\r\n        //Check for a pullback.\r\n        return await checkPullBack(twenty.highPrice, -4, indexDate, args.ticker);\r\n      }\r\n  }\r\n});\r\n\r\n\r\n//Get the price for today for each product \r\nPriceTC.addResolver({\r\n  name: \"pricesUniverse\",\r\n  type: [\"Price\"],\r\n  resolve: async ({args, source, context}) => {\r\n      let indexDate = format(subDays(new Date(), 1), 'yyyy-MM-dd')+\"T00:00:00.000Z\";\r\n      console.log(indexDate);\r\n      let price_array = [];\r\n\r\n      await Promise.all(universe.universe.map(async (stock)=>{\r\n        let prices = await Price.findOne({\r\n          'date':indexDate,\r\n          'ticker': stock.ticker\r\n        });\r\n        if(prices)\r\n        price_array.push(prices);\r\n      }))\r\n      return price_array;\r\n  }\r\n});\r\n\r\n\r\n/*\r\n * Check if there was a 20 day high followed by a 4 day pullback.\r\n * This method is commonly referred to as the Four Candle Hammer Algorithm.\r\n * Parameters:        prevhigh  =>  High $ to check to pullback against.\r\n *                    number    =>  number of days to check for a pullback. Default is 4.\r\n *                    date      =>  Date to check the four candle hammer around (will often be today).\r\n *                    ticker    =>  Ticker symbol for the stock.\r\n *\r\n */\r\nasync function checkPullBack(prevhigh, number, date, ticker){\r\n  let amount = number || -4;\r\n  let indexDate = new Date(date);\r\n  let pullbackDate = new Date(addDays(indexDate, amount));\r\n  let prices = await Price.find({\r\n    'date':{\r\n      $lte:indexDate,\r\n      $gt:pullbackDate\r\n    },\r\n    'ticker':ticker\r\n  });\r\n  let high = prevhigh;\r\n  let check = true;\r\n  _.forEach(prices, price => {\r\n    if(price.openPrice > high){\r\n      check = false;\r\n    }\r\n  });\r\n  return check;\r\n}\r\n\r\n\r\n\r\nasync function CheckTwentyDay(date, ticker){\r\n  let indexDate = new Date(date);\r\n  let twentyBefore = new Date(addDays(indexDate, -20));\r\n  let prices = await Price.find({\r\n    'date':{\r\n      $lte:indexDate,\r\n      $gt:twentyBefore\r\n    },\r\n    'ticker':ticker\r\n  });\r\n\r\n  let high = 0.0;\r\n  let highPriceDate = indexDate;\r\n  _.forEach(prices, price => {\r\n    if(price.closePrice > high){\r\n      high = price.closePrice;\r\n      highPriceDate = price.date\r\n    }\r\n  });\r\n  if(differenceInDays(indexDate, highPriceDate) == 0){\r\n    return {\r\n      highCheck:true,\r\n      highDate: highPriceDate,\r\n      highPrice:high\r\n    }\r\n  } else {\r\n    return {\r\n      highCheck:false,\r\n      highDate: highPriceDate,\r\n      highPrice:high\r\n    }\r\n  }\r\n}\r\n\r\nexport { PriceTC };"],"file":"price.js"}