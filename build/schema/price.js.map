{"version":3,"sources":["../../src/schema/price.js"],"names":["moment","require","momentTZ","_","addDays","differenceInDays","subDays","format","updateLocale","workingWeekdays","priceSchema","mongoose","Schema","openPrice","type","Number","description","required","closePrice","volume","date","Date","index","ticker","String","Price","model","customizationOptions","PriceTC","addFields","bull","resolve","source","findOne","sort","yestPrice","NULL","addResolver","name","args","context","CheckTwentyDay","highCheck","indexDate","twentyDayHighDate","twenty","checkPullBack","highPrice","latestPrices","map","universe","priceObjects","Promise","all","prevhigh","number","amount","pullbackDate","find","$lte","$gt","prices","high","check","forEach","price","twentyBefore","highPriceDate","highDate"],"mappings":"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","sourcesContent":["import { composeWithMongoose } from 'graphql-compose-mongoose/node8';\r\nimport mongoose, { mongo } from 'mongoose';\r\nimport universe from '../universe';\r\nvar moment = require('moment-business-days');\r\nvar momentTZ = require('moment-timezone');\r\n\r\n// import { addHours } from 'date-fns/esm';\r\n\r\nvar _ = require('lodash');\r\nvar addDays = require('date-fns/addDays');\r\nvar differenceInDays = require('date-fns/differenceInDays')\r\nvar subDays = require('date-fns/subDays')\r\nvar format = require('date-fns/format')\r\n\r\n\r\nmoment.updateLocale('us', {\r\n  workingWeekdays: [1, 2, 3, 4, 5]\r\n});\r\n\r\nconst priceSchema = new mongoose.Schema({\r\n  openPrice: {\r\n    type: Number,\r\n    description: \"Opening Price of Stock.\",\r\n    required: true\r\n  }, \r\n  closePrice: {\r\n    type: Number,\r\n    description: \"Closing Price of Stock.\",\r\n    required: true\r\n  }, \r\n  volume: {\r\n    type: Number,\r\n    description: \"Volume of Stocks sold that day.\",\r\n    required: true\r\n  }, \r\n  date: {\r\n    type: Date,\r\n    description: \"Date-Time for this price.\",\r\n    required: true,\r\n    index: true\r\n  },\r\n  ticker: {\r\n    type: String,\r\n    description: \"Stock this price is associated with.\",\r\n    required: true,\r\n    index:true\r\n  }\r\n});\r\n\r\n\r\nconst Price = mongoose.model('Price', priceSchema);\r\nconst customizationOptions = {};\r\nconst PriceTC = composeWithMongoose(Price, customizationOptions);\r\n\r\n\r\nPriceTC.addFields({\r\n  bull: () => ({\r\n    type: \"Boolean\",\r\n    resolve: async (source) => {\r\n      let yestPrice = await Price.findOne({ticker: source.ticker}).sort({date: -1})\r\n      if(yestPrice){\r\n        return yestPrice.closePrice < source.openPrice\r\n      }\r\n      return NULL;\r\n    }\r\n  })\r\n})\r\n\r\nPriceTC.addResolver({\r\n  name: \"checkTwentyDayHigh\",\r\n  type: \"Boolean\",\r\n  args: {\r\n    date: \"Date!\",\r\n    ticker: \"String!\"\r\n  },\r\n  resolve: async ({args, source, context}) => {\r\n    return await CheckTwentyDay(args.date).highCheck\r\n  }\r\n})\r\n\r\n\r\nPriceTC.addResolver({\r\n  name: \"fourCandleHammer\",\r\n  type: \"Boolean\",\r\n  args: {\r\n    date: \"Date!\",\r\n    ticker: \"String!\",\r\n  },\r\n  resolve: async ({args, source, context}) => {\r\n      let indexDate = new Date(args.date);\r\n      let twentyDayHighDate = new Date(addDays(indexDate, -24));\r\n      let twenty = await CheckTwentyDay(twentyDayHighDate);\r\n      if(twenty.highCheck){\r\n        return await checkPullBack(twenty.highPrice, -4, indexDate, args.ticker);\r\n      }\r\n  }\r\n});\r\n\r\n\r\n//Get the price for today for each product \r\nPriceTC.addResolver({\r\n  name: \"pricesUniverse\",\r\n  type: [\"Price\"],\r\n  resolve: async ({args, source, context}) => {\r\n      let indexDate = format(subDays(new Date(), 1), 'yyyy-MM-dd')+\"T00:00:00.000Z\";\r\n      let latestPrices = _.map(universe.universe, priceObjects => {\r\n        return Price.findOne({ticker: priceObjects.ticker}).sort({date: -1})\r\n      })\r\n      return Promise.all(latestPrices);\r\n  }\r\n});\r\n\r\n\r\n/*\r\n * Check if there was a 20 day high followed by a 4 day pullback.\r\n * This method is commonly referred to as the Four Candle Hammer Algorithm.\r\n * Parameters:        prevhigh  =>  High $ to check to pullback against.\r\n *                    number    =>  number of days to check for a pullback. Default is 4.\r\n *                    date      =>  Date to check the four candle hammer around (will often be today).\r\n *                    ticker    =>  Ticker symbol for the stock.\r\n *\r\n */\r\nasync function checkPullBack(prevhigh, number, date, ticker){\r\n  let amount = number || -4;\r\n  let indexDate = new Date(date);\r\n  let pullbackDate = new Date(addDays(indexDate, amount));\r\n  let prices = await Price.find({\r\n    'date':{\r\n      $lte:indexDate,\r\n      $gt:pullbackDate\r\n    },\r\n    'ticker':ticker\r\n  });\r\n  let high = prevhigh;\r\n  let check = true;\r\n  _.forEach(prices, price => {\r\n    if(price.openPrice > high){\r\n      check = false;\r\n    }\r\n  });\r\n  return check;\r\n}\r\n\r\n\r\n\r\nasync function CheckTwentyDay(date, ticker){\r\n  let indexDate = new Date(date);\r\n  let twentyBefore = new Date(addDays(indexDate, -20));\r\n  let prices = await Price.find({\r\n    'date':{\r\n      $lte:indexDate,\r\n      $gt:twentyBefore\r\n    },\r\n    'ticker':ticker\r\n  });\r\n\r\n  let high = 0.0;\r\n  let highPriceDate = indexDate;\r\n  _.forEach(prices, price => {\r\n    if(price.closePrice > high){\r\n      high = price.closePrice;\r\n      highPriceDate = price.date\r\n    }\r\n  });\r\n  if(differenceInDays(indexDate, highPriceDate) == 0){\r\n    return {\r\n      highCheck:true,\r\n      highDate: highPriceDate,\r\n      highPrice:high\r\n    }\r\n  } else {\r\n    return {\r\n      highCheck:false,\r\n      highDate: highPriceDate,\r\n      highPrice:high\r\n    }\r\n  }\r\n}\r\n\r\nexport { PriceTC };"],"file":"price.js"}