{"version":3,"sources":["../../src/schema/price.js"],"names":["moment","require","momentTZ","_","addDays","differenceInDays","subDays","format","updateLocale","workingWeekdays","priceSchema","mongoose","Schema","openPrice","type","Number","description","required","closePrice","volume","date","Date","index","ticker","String","bull","Boolean","desctption","post","prev","tz","prevBusinessDay","console","log","Price","findOne","yestPrice","model","customizationOptions","PriceTC","addResolver","name","args","resolve","source","context","CheckTwentyDay","highCheck","prices1","indexDate","twentyDayHighDate","twenty","checkPullBack","highPrice","price_array","Promise","all","universe","map","stock","prices","push","prevhigh","number","amount","pullbackDate","find","$lte","$gt","high","check","forEach","price","twentyBefore","highPriceDate","highDate"],"mappings":"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","sourcesContent":["import { composeWithMongoose } from 'graphql-compose-mongoose/node8';\r\nimport mongoose, { mongo } from 'mongoose';\r\nimport universe from '../universe';\r\nvar moment = require('moment-business-days');\r\nvar momentTZ = require('moment-timezone');\r\n\r\n// import { addHours } from 'date-fns/esm';\r\n\r\nvar _ = require('lodash');\r\nvar addDays = require('date-fns/addDays');\r\nvar differenceInDays = require('date-fns/differenceInDays')\r\nvar subDays = require('date-fns/subDays')\r\nvar format = require('date-fns/format')\r\n\r\n\r\nmoment.updateLocale('us', {\r\n  workingWeekdays: [1, 2, 3, 4, 5]\r\n});\r\n\r\nconst priceSchema = new mongoose.Schema({\r\n  openPrice: {\r\n    type: Number,\r\n    description: \"Opening Price of Stock.\",\r\n    required: true\r\n  }, \r\n  closePrice: {\r\n    type: Number,\r\n    description: \"Closing Price of Stock.\",\r\n    required: true\r\n  }, \r\n  volume: {\r\n    type: Number,\r\n    description: \"Volume of Stocks sold that day.\",\r\n    required: true\r\n  }, \r\n  date: {\r\n    type: Date,\r\n    description: \"Date-Time for this price.\",\r\n    required: true,\r\n    index: true\r\n  },\r\n  ticker: {\r\n    type: String,\r\n    description: \"Stock this price is associated with.\",\r\n    required: true,\r\n    index:true\r\n  },\r\n  bull: {\r\n    type: Boolean,\r\n    desctption: \"Whether or not the stock is up from the previous day.\"\r\n  }\r\n});\r\n\r\n\r\npriceSchema.post('save', async function() {\r\n  let prev = momentTZ(this.date).tz(\"America/Phoenix\").prevBusinessDay().format('YYYY-MM-DD') + \"T00:00:00.000Z\";\r\n    console.log(\"Previous: \", prev)\r\n    let yestPrice = await Price.findOne({\r\n      'date':prev,\r\n      'ticker': this.ticker \r\n    });\r\n    if(yestPrice){\r\n      this.bull= prev.closePrice < this.openPrice\r\n    }\r\n});\r\n\r\nconst Price = mongoose.model('Price', priceSchema);\r\nconst customizationOptions = {};\r\nconst PriceTC = composeWithMongoose(Price, customizationOptions);\r\n\r\nPriceTC.addResolver({\r\n  name: \"checkTwentyDayHigh\",\r\n  type: \"Boolean\",\r\n  args: {\r\n    date: \"Date!\",\r\n    ticker: \"String!\"\r\n  },\r\n  resolve: async ({args, source, context}) => {\r\n    return await CheckTwentyDay(args.date).highCheck\r\n  }\r\n})\r\n\r\n\r\nPriceTC.addResolver({\r\n  name: \"UpdateBull\",\r\n  type: \"Boolean\",\r\n  resolve: async({args, source, context}) => {\r\n    let prev = momentTZ(new Date()).tz(\"America/Phoenix\").prevBusinessDay().format('YYYY-MM-DD') + \"T00:00:00.000Z\";\r\n\r\n    let prices1 = await Price.findOne({\r\n      'date':prev,\r\n      'ticker': args.ticker\r\n    });\r\n\r\n\r\n  }\r\n})\r\n\r\nPriceTC.addResolver({\r\n  name: \"fourCandleHammer\",\r\n  type: \"Boolean\",\r\n  args: {\r\n    date: \"Date!\",\r\n    ticker: \"String!\",\r\n  },\r\n  resolve: async ({args, source, context}) => {\r\n      let indexDate = new Date(args.date);\r\n      let twentyDayHighDate = new Date(addDays(indexDate, -24));\r\n      let twenty = await CheckTwentyDay(twentyDayHighDate);\r\n      if(twenty.highCheck){\r\n        //Check for a pullback.\r\n        return await checkPullBack(twenty.highPrice, -4, indexDate, args.ticker);\r\n      }\r\n  }\r\n});\r\n\r\n\r\n//Get the price for today for each product \r\nPriceTC.addResolver({\r\n  name: \"pricesUniverse\",\r\n  type: [\"Price\"],\r\n  resolve: async ({args, source, context}) => {\r\n      let indexDate = format(subDays(new Date(), 1), 'yyyy-MM-dd')+\"T00:00:00.000Z\";\r\n      console.log(indexDate);\r\n      let price_array = [];\r\n\r\n      await Promise.all(universe.universe.map(async (stock)=>{\r\n        let prices = await Price.findOne({\r\n          'date':indexDate,\r\n          'ticker': stock.ticker\r\n        });\r\n        if(prices)\r\n        price_array.push(prices);\r\n      }))\r\n      return price_array;\r\n  }\r\n});\r\n\r\n\r\n/*\r\n * Check if there was a 20 day high followed by a 4 day pullback.\r\n * This method is commonly referred to as the Four Candle Hammer Algorithm.\r\n * Parameters:        prevhigh  =>  High $ to check to pullback against.\r\n *                    number    =>  number of days to check for a pullback. Default is 4.\r\n *                    date      =>  Date to check the four candle hammer around (will often be today).\r\n *                    ticker    =>  Ticker symbol for the stock.\r\n *\r\n */\r\nasync function checkPullBack(prevhigh, number, date, ticker){\r\n  let amount = number || -4;\r\n  let indexDate = new Date(date);\r\n  let pullbackDate = new Date(addDays(indexDate, amount));\r\n  let prices = await Price.find({\r\n    'date':{\r\n      $lte:indexDate,\r\n      $gt:pullbackDate\r\n    },\r\n    'ticker':ticker\r\n  });\r\n  let high = prevhigh;\r\n  let check = true;\r\n  _.forEach(prices, price => {\r\n    if(price.openPrice > high){\r\n      check = false;\r\n    }\r\n  });\r\n  return check;\r\n}\r\n\r\n\r\n\r\nasync function CheckTwentyDay(date, ticker){\r\n  let indexDate = new Date(date);\r\n  let twentyBefore = new Date(addDays(indexDate, -20));\r\n  let prices = await Price.find({\r\n    'date':{\r\n      $lte:indexDate,\r\n      $gt:twentyBefore\r\n    },\r\n    'ticker':ticker\r\n  });\r\n\r\n  let high = 0.0;\r\n  let highPriceDate = indexDate;\r\n  _.forEach(prices, price => {\r\n    if(price.closePrice > high){\r\n      high = price.closePrice;\r\n      highPriceDate = price.date\r\n    }\r\n  });\r\n  if(differenceInDays(indexDate, highPriceDate) == 0){\r\n    return {\r\n      highCheck:true,\r\n      highDate: highPriceDate,\r\n      highPrice:high\r\n    }\r\n  } else {\r\n    return {\r\n      highCheck:false,\r\n      highDate: highPriceDate,\r\n      highPrice:high\r\n    }\r\n  }\r\n}\r\n\r\nexport { PriceTC };"],"file":"price.js"}